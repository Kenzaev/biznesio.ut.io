let products = [];
let cart = JSON.parse(localStorage.getItem('cart')) || [];
let currentProduct = null;
let currentQuantity = 1;
let isAdmin = false;

// Функция для получения продуктов с сервера
async function fetchProducts() {
    const response = await fetch('http://localhost:5000/api/products');
    if (response.ok) {
        products = await response.json();
        displayProducts();
    } else {
        alert('Ошибка при загрузке продуктов');
    }
}

// Функция для отображения товаров
function displayProducts(filteredProducts = products) {
    const productsDiv = document.getElementById("product-gallery");
    productsDiv.innerHTML = '';
    filteredProducts.forEach((product, index) => {
        const productDiv = document.createElement("div");
        productDiv.className = "product-card";
        productDiv.innerHTML = `
            <h2>${product.name}</h2>
            <img src="${product.image}" alt="${product.name}" width="100" onerror="this.onerror=null;this.src='https://via.placeholder.com/150';">
            <p>Цена: ${product.price}₽</p>
            <button class="btn" onclick="orderNow('${product.name}')">Заказать сейчас</button>
            <button class="btn" onclick="addToCart('${product.name}', ${product.price})">В корзину</button>
            <button class="btn" onclick="viewVideo('${product.video}')">Обзор</button>
            ${isAdmin ? `<button class="btn" onclick="deleteProduct(${index})">Удалить</button>` : ''}
        `;
        productDiv.addEventListener('click', () => openModal(product));
        productsDiv.appendChild(productDiv);
    });
}

// Функция для добавления продукта
async function addProduct() {
    const name = document.getElementById("product-name").value;
    const price = parseFloat(document.getElementById("product-price").value);
    const video = document.getElementById("product-video").value;
    const imageFile = document.getElementById("product-image").files[0];

    if (name && price && video && imageFile) {
        const formData = new FormData();
        formData.append('name', name);
        formData.append('price', price);
        formData.append('video', video);
        formData.append('image', imageFile);

        const response = await fetch('http://localhost:5000/api/products', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            alert('Товар добавлен!');
            fetchProducts(); // Обновляем список продуктов
        } else {
            alert('Ошибка при добавлении товара');
        }
    } else {
        alert('Пожалуйста, заполните все поля и выберите изображение');
    }
}

// Функция для удаления продукта
async function deleteProduct(index) {
    const response = await fetch(`http://localhost:5000/api/products/${products[index]._id}`, {
        method: 'DELETE'
    });

    if (response.ok) {
        alert('Товар удален!');
        fetchProducts(); // Обновляем список продуктов
    } else {
        alert('Ошибка при удалении товара');
    }
}

// Инициализация отображения продуктов
fetchProducts();
displayCart();
